language: node_js
node_js:
- '4'
services:
- mongodb
cache:
  directories:
  - node_modules
before_install:
  - printf "registry=https://artifactory.digital.homeoffice.gov.uk/artifactory/api/npm/npm-virtual\n_auth=${NPM_TOKEN}\nalways-auth=true\nemail=${NPM_EMAIL}\n" >> .npmrc
before_script:
- npm run sass
- NODE_ENV='ci' npm start &
script:
- npm run test:ci
- npm run mock &
- npm run test:acceptance
after_success:
- git config --global user.email "builds@travis-ci.com"
- git config --global user.name "Travis CI"
- export GIT_TAG=build-$TRAVIS_BRANCH-$(date -u "+%Y-%m-%d")-$TRAVIS_BUILD_NUMBER
- echo -n $GIT_TAG > version
- git commit -m "Set build version number" version
- git tag $GIT_TAG -a -m "Generated tag from TravisCI build $TRAVIS_BUILD_NUMBER"
- git push --quiet https://$GITHUBKEY@github.com/UKHomeOffice/evw-self-serve $GIT_TAG
  > /dev/null 2>&1
branches:
  except:
  - "/^build-[0-9a-z\\-]*/"
addons:
  apt:
    packages:
    - rpm
deploy:
  provider: releases
  api_key:
    secure: AJYAfy4Ojm4P1SCXvYuduf5zRGx6stxSlxJwPx+5fUefVMfPGa/Ppek1ajWYjg0fh6X4OXEHqdIU2pZKx8x70xW22jDKodGpG12E76/9QG+5nc5wd4Em2fOOkA+9r/JoNzO23FmoAo0ZGb6lZ53QK104dN36K8c8trVwHb+iZ3G5QWSpYikuMKOxx+b0FOBOlndYF6sMHykydwTVUuZLE4vYoqhpLNgjewIot5PhZq/T1L0TcZ2vqSkxTy0Z48fK+V5jNrro3r6oHKQAZAbId/TV0XrNxZv3BQRqZEBvQZUxo4MrUULasFowMDoOfdnyhW82ewxsu4l+g+ErycORtOJ1Cq/HSATeFLs36Ba/FWDd+p/EHQaX+CDsyENUx+su5oJRGI0jDx15j/CNrCfOO6ty1QW7G3k3iIUtcezMdyoEq4ww34uwqP+mG4HWIRwy7I41k8EiR3haEWIQhfynq+rh6QUgaIj+zHaAwMMZ3uo50GqrRDhqSQqMt9vAadGzBSd5hmtOoThgkVv3xXaGEu49KzNFMU6U1EM8FGn8gQEgb9nRS8E1oK59v6E/5nlhnGHiuQru2Mp7aM1oy39N92KoewBWN8UNr3lNS5wc/iF0CDIFcOy3NBD3k4VTDe2qtwnjIctb0wTwtD5tgE3UPKgnle/vjDMRPTmoJhgnCeI=
  skip_cleanup: true
  on:
    repo: UKHomeOffice/evw-self-serve
    branch: feature/new-flight-service
    all_branches: false
notifications:
  slack:
    secure: "L72c2eUbeBM5iaMTfxg9jx2nSQNjWxoBHhjT16whyakQZ1C0JqymtLC2y3MoiOoi59cT6WGa0X9jUdKhvygrUccJAmKlEfSUM60pCXBasXd6UHnbu/fBUXuGCumHGzm/VbsEaLGoMw3OUK8J+yxrYQtl4Zd6vfeaLy7Xq76Wkt5imwTyYCQ61wMbKkvXFIqCdTOZAxd4CSBVLf809tg3ULX5DgF6FjxO8R8uSUdztzFBwD2oAylLOZA0QbfiU7Fd0xYI+i3huxNSSSE8sT8ZpZ9YkHkJ4ChF6uQtWfGm2t+v0xwVCdBwIqyiCaZ+nlIC+a6nD19a4iBKyR47nE3TJh8YODBbvC/sVmY4TOLfIah+brGYUCUIMTPFAF7u7keyOqfZWM7JCJM6257rZfHewXr8NR7I2TEAdLAzEpDTpvSqcebNmGG4P3mJdaDaa2tTJtszZT3QFFb1qRkQ08yqRANlOGHRDRlzI5ucxGshTtx/OH295Te7FQzKb3k7mq90jT/lkRrPlySgejPCgUllkTtVG3pgPxbW1Yclgw5ImgyhSqEr1NrPIc1dH/7izxGYA3Y9oeZ1G7C/Vm2EsKnsr7E+R3LAGQcyHWc8m1SMG6CLAgS7u9lOLXEEAdsL2OIMerC9qksoIHmkYBdb8e84wQCZu+K/6OHPff8jbKg0/gs="
