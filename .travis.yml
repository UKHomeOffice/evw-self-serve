language: node_js

node_js:
  - '4'

services:
  - redis-server

cache:
  directories:
    - node_modules

before_script:
  - npm run sass
  - NODE_ENV='ci' npm start&

script:
  - npm run test:ci
  - npm run test:acceptance

after_success:
  # CREATE GIT TAG
  - git config --global user.email "builds@travis-ci.com"
  - git config --global user.name "Travis CI"
  - export GIT_TAG=build-$TRAVIS_BRANCH-$(date -u "+%Y-%m-%d")-$TRAVIS_BUILD_NUMBER
  - echo -n $GIT_TAG > version
  - git commit -m "Set build version number" version
  - git tag $GIT_TAG -a -m "Generated tag from TravisCI build $TRAVIS_BUILD_NUMBER"
  - git push --quiet https://$GITHUBKEY@github.com/UKHomeOffice/evw-self-serve $GIT_TAG > /dev/null 2>&1

branches:
  except:
    - /^build-[0-9a-z\-]*/


deploy:
  provider: releases
  api_key:
    secure: AJYAfy4Ojm4P1SCXvYuduf5zRGx6stxSlxJwPx+5fUefVMfPGa/Ppek1ajWYjg0fh6X4OXEHqdIU2pZKx8x70xW22jDKodGpG12E76/9QG+5nc5wd4Em2fOOkA+9r/JoNzO23FmoAo0ZGb6lZ53QK104dN36K8c8trVwHb+iZ3G5QWSpYikuMKOxx+b0FOBOlndYF6sMHykydwTVUuZLE4vYoqhpLNgjewIot5PhZq/T1L0TcZ2vqSkxTy0Z48fK+V5jNrro3r6oHKQAZAbId/TV0XrNxZv3BQRqZEBvQZUxo4MrUULasFowMDoOfdnyhW82ewxsu4l+g+ErycORtOJ1Cq/HSATeFLs36Ba/FWDd+p/EHQaX+CDsyENUx+su5oJRGI0jDx15j/CNrCfOO6ty1QW7G3k3iIUtcezMdyoEq4ww34uwqP+mG4HWIRwy7I41k8EiR3haEWIQhfynq+rh6QUgaIj+zHaAwMMZ3uo50GqrRDhqSQqMt9vAadGzBSd5hmtOoThgkVv3xXaGEu49KzNFMU6U1EM8FGn8gQEgb9nRS8E1oK59v6E/5nlhnGHiuQru2Mp7aM1oy39N92KoewBWN8UNr3lNS5wc/iF0CDIFcOy3NBD3k4VTDe2qtwnjIctb0wTwtD5tgE3UPKgnle/vjDMRPTmoJhgnCeI=
  file: $TRAVIS_BUILD_NUMBER-build.zip
  on:
    repo: UKHomeOffice/evw-self-serve
